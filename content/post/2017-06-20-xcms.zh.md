---
title: xcms 包参数及优化
author: 'Dong'
date: '2017-06-20'
slug: xcms
summary: "XCMS 是基于 R 语言的用于处理分析 LC(GC)-MS 的软件。优点是自主性强，使用灵活方便，但参数优化较为复杂。"
tags: [xcms]
toc: true
---

# 1.说明

1. 这篇博文主要参考了 [Stanstrup](https://github.com/stanstrup/XCMS-course)
和 [workflow4metabolomics](http://workflow4metabolomics.org/sites/workflow4metabolomics.org/files/w4e2017-EC_MSprocessing_LC-MS-2017.pdf) 提供的教程，在此感谢。     

2. R 软件包 [IPO](https://bioconductor.org/packages/devel/bioc/vignettes/IPO/inst/doc/IPO.html) 或许是一个不错的 xcms 参数优化工具。我说“或许”是因为我尝试了几次 IPO 包，但都因为运行时间过长（> 12h）无果而终。


# 2.关于 xcms

xcms 数据处理步骤及对应代码如下图所示：  

![xcms overview](/img/xcms_overview.png)
图1. xcms 步骤

# 3.准备

## 3.1 安装数据包  

```r
source("https://bioconductor.org/biocLite.R")
biocLite("xcms")
biocLite("BiocParallel")
```     

## 3.2 加载数据包      

```r
library(xcms)
library(BiocParallel)
```

## 3.3 数据格式

- mzML
- mzData
- mzXML
- netCDF

原始数据可以用色谱-质谱公司自带的软件或  [ProteoWizard](http://proteowizard.sourceforge.net) 转化为 xcms 所支持的格式。

# 4. 数据处理

## 4.1 峰值检出（Peak Picking） 

该步对应图1中的 `Filter and Idenfity Peak` - 过滤和峰检测, 主要有两种方法：     

`MatchedFilter` ： 适用于 profile 或 centroid 模式下的低分辨率数据    
`Centwave`：适用于 centroid 模式下的高分辨数据    

我平时用到的都是高分辨数据，所以这里我只专注 Centwave 法。关于 profile 和 centroid 模式的区别，可以参考[我的这篇博文](http://www.biodong.com/cn/2013/10/30/profile_centroid_mode/)。   

代码如下：

```r
xset <- xcmsSet(files, 
                BPPARAM  = SerialParam(),
                method = 'centWave',
                prefilter = c(3,1000),
                ppm = 30,
                snthr = 10,
                profparam = list(step=0.01),
                peakwidth = c(0.05*60,0.20*60),
                verbose.columns = TRUE,
                fitgauss = TRUE
                )
```     

主要参数： 

- `prefilter`: 初过滤。prefilter = c(3, 1000) 的意思是一个色谱峰里至少有 3 个扫描点（scan），并且峰强大于 1000 时，它才是一个意义的色谱峰，反之则是噪音。  

- `ppm`： 连续扫描中 _m/z_ 的最大容忍偏差，单位：ppm。可以通过原始数据估计该参数的大小。
 {{% alert note %}}
 仪器公司所提供的精确度都是在最优条件下测量的，所以不要只通说明书里的数据来选择该参数大小。
 {{% /alert %}}     

- `snthr`: 信噪比。    

- `peakwidth`：色谱峰宽，单位：秒。这个参数也是通过查看原始数据来估计峰宽范围的。
 {{% alert note %}}
这个参数只是估计峰宽的范围，所以不要求给它的精确阈值。 HPLC 中基峰的峰宽一般在 20-60 秒。在 peakwidth = c(20, 60) 设置下，_centWave_ 法同样能检测出峰宽为 15 或 80 秒的峰。值得注意的是峰宽区间不要设定的过小，它并不会提高峰值检出的灵敏度，反而可能会导致出现裂峰。
 {{% /alert %}}      

## 4.2 分组（Grouping）

该步骤对应图1中的 `Match Peaks Across Samples` - 数据组间的峰匹配。这一步的目的是确定样品间保留时间和质荷比 有微小的差异的峰是否属于同一种峰。图2直观显示了通过校正保留时间与质荷比，把样品间相同的峰对应在了一起。

![group](/img/group.png)
图2. 保留时间和质荷比有微小差异的同一种峰最后被分到同一组。        

代码如下：

```r
xset_g <- group(xset, 
                bw = 0.2*60, 
                minfrac = 0.5, 
                minsamp = 5, 
                mzwid = 0.01, 
                max = 20, 
                sleep = 0
                )
```

主要参数：      

- `bw`: 计算色谱图峰密度的高斯平滑核的标准偏差或半值宽。单位：秒。这个概念很难理解，但可以认为它描述的是样品中同一种色谱峰保留时间之间的最大差值。这个差值可以通过原始数据来估计。方法如图3和图4所示：       

![group_bw](/img/group_bw.png)
图3. 通过叠加数据来寻找保留时间偏差最大的色谱峰

![group_bw_zoom](/img/group_bw_zoom.png)
图4. 放大该色谱峰，计算保留时间偏差

比如图4里，可以计算出这个放大的色谱峰的保留时间偏差为 4.90 - 4.78 = 0.12 分钟。所以上面的代码里取了 0.2 分钟。       

- `minfrac` 和 `minsamp`: 这两个参数的含义相同。当一个峰在一个组中至少有 n 个样本（minsamp）里或者 n% 的样本（minfrac）里存在时，它才被认为为一个有意义的（真正的）峰。这里我举个例子：


Sample | Group
:---: | :---: 
ko1 | KO 
... | KO 
ko6 | KO 
wt1 | WT
... | WT 
wt6 | WT

上表中有两个组，KO 和 WT。每个组各有 6 个样本。minsamp = 3，指的是一个组中至少 3 个样本里存在该峰时，这个峰就是一个真正的峰。minfrac = 0.5，指的是一个组中至少 50% 的样本里存在该峰时，这个峰就是一个真正的峰。    

- `mzwid`: 被认为是同一种峰的荷质比最大差异耐受值（binning size），。

- `max`：色谱峰里包含的最大限度的质谱峰数量。气相色谱里的碎片很多，所以这个参数在气相中要比液相中大。     

## 4.3 保留时间校正 (Retention Time Correction)        

这一步对应图1中的 `Retention Time Correction` - 样本间保留时间校正。有三种方法：

`Loess`: 用局部加权回归散点平滑法 （Loess）非线性校正保留时间。       
`Linear`：线性校正保留时间。   
`Obiwarp`：用参考样本对原始数据进行翘曲变形（warping），易出现过拟合。

代码如下：

```r
xset_g_r <- retcor(xset_g,
                   method="peakgroups",
                   missing = 3, 
                   extra = 3, 
                   smooth = "loess",
                   span = 0.6, 
                   plottype = "mdevden",
                   col=xset_g@phenoData[,"class"]
                  )
```

主要参数：

- `missing` 和 `extra`：只对最多只有 n 个缺失样本（missing）和最多有 n 个 “额外”峰（extra）的组进行保留时间校正。     

- `extra`：允许保留时间校正的最多的“额外”峰的数目。默认值是 1。

- `span`：LOESS 的平滑度。数值越大灵活度越低，span = 0 会出现过拟合，span = 1 则会欠拟合。默认值为 0.2，常用取值在 0.4-0.7之间。      

- `plottype`：画图的类型。`mdevden`：只画出保留时间的偏差； `mdevden`：在保留时间的偏差图下额外画一个密度图。       

## 4.4 分组（Grouping）        

同 4.2。用校正过的保留时间再进行一次分组。这次在 `bw`, `minfrac` 和 `minsamp` 参数上选择可以更严格。代码如下：

```r
xset_g_r_g <- group(xset_g_r,
                    bw = 5, 
                    minfrac = 0.75, 
                    minsamp = 7, 
                    mzwid = 0.01, 
                    max = 20, 
                    sleep = 0
                   )

```

## 4.5 填峰（Filling Missing Values）  

这一步对应图1中的 `Filling Missing Peak Data` - 填充缺失峰值。因为确失值（NA）不利于后续统计分析，所以需要对缺失值进行填充（图5）。

![miss peak filling](/img/fill.png)
图5. 填充缺失峰值


对应代码如下：      

```r
xset_g_r_g_fill <- fillPeaks(xset_g_r_g, 
                             method="chrom"
                            )
```

主要参数：

- method：`chrom`用于 LC-MS；`MSW` 用于直接注入式分析（direct infusion）。       

# 5.附录       

Patti 等在 [Meta-analysis of untargeted metabolomic data from multiple profiling experiments](http://www.nature.com/nprot/journal/v7/n3/full/nprot.2011.454.html) 文章中针对不同的质谱建议了一些 xcms 中的重要参数的取值，个人感觉挺有参考价值，所以附录如下：

![xcms parameters](/img/xcms_parameters.png)
图6. 针对不同质谱建议的一些 xcms 参数


